name: Auto Promote Canary

on:
  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: '0 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout config repo
      uses: actions/checkout@v3
      with:
        repository: ${{ github.repository_owner }}/miniproject-config
        token: ${{ secrets.GH_PAT }}
        path: config

    - name: Check and promote canary
      run: |
        cd config
        
        # è·å– canary çš„é•œåƒ tag
        CANARY_IMAGE=$(grep "image:" base/deployment-canary.yaml | awk '{print $2}')
        STABLE_IMAGE=$(grep "image:" base/deployment-stable.yaml | awk '{print $2}')
        
        echo "Canary image: $CANARY_IMAGE"
        echo "Stable image: $STABLE_IMAGE"
        
        # å¦‚æœ canary å’Œ stable é•œåƒç›¸åŒï¼Œè¯´æ˜å·²ç»æ™‹çº§è¿‡äº†
        if [ "$CANARY_IMAGE" = "$STABLE_IMAGE" ]; then
          echo "Canary and Stable are already in sync. Nothing to promote."
          exit 0
        fi
        
        # è·å– canary deployment çš„æœ€åä¿®æ”¹æ—¶é—´
        LAST_COMMIT_TIME=$(git log -1 --format=%ct -- base/deployment-canary.yaml)
        CURRENT_TIME=$(date +%s)
        TIME_DIFF=$((CURRENT_TIME - LAST_COMMIT_TIME))
        
        # 4 å°æ—¶ = 14400 ç§’
        PROMOTION_THRESHOLD=14400
        
        echo "Time since last canary update: $((TIME_DIFF / 3600)) hours"
        
        if [ $TIME_DIFF -gt $PROMOTION_THRESHOLD ]; then
          echo "Canary has been running for more than 4 hours. Promoting to stable..."
          
          # æ›´æ–° stable deployment çš„é•œåƒä¸º canary çš„é•œåƒ
          sed -i "s|image:.*|image: $CANARY_IMAGE|g" base/deployment-stable.yaml
          
          # æäº¤å¹¶æ¨é€
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add base/deployment-stable.yaml
          git commit -m "chore: auto-promote canary to stable

Canary image: $CANARY_IMAGE
Promotion after: $((TIME_DIFF / 3600)) hours

ğŸ¤– Automated promotion by GitHub Actions"
          git push
          
          echo "âœ… Promotion completed!"
        else
          echo "Canary has been running for less than 4 hours. Skipping promotion."
        fi

name: Auto Promote Canary

on:
  schedule:
    # Run once every hour
    - cron: '0 * * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout config repo
      uses: actions/checkout@v3
      with:
        repository: ${{ github.repository_owner }}/miniproject-config
        token: ${{ secrets.GH_PAT }}
        path: config

    - name: Check and promote canary
      run: |
        cd config
        
        # Get canary image tag
        CANARY_IMAGE=$(grep "image:" base/deployment-canary.yaml | awk '{print $2}')
        STABLE_IMAGE=$(grep "image:" base/deployment-stable.yaml | awk '{print $2}')
        
        echo "Canary image: $CANARY_IMAGE"
        echo "Stable image: $STABLE_IMAGE"
        
        # If canary and stable images are the same, it means promotion has already occurred
        if [ "$CANARY_IMAGE" = "$STABLE_IMAGE" ]; then
          echo "Canary and Stable are already in sync. Nothing to promote."
          exit 0
        fi
        
        # Get the last modification time of the canary deployment
        LAST_COMMIT_TIME=$(git log -1 --format=%ct -- base/deployment-canary.yaml)
        CURRENT_TIME=$(date +%s)
        TIME_DIFF=$((CURRENT_TIME - LAST_COMMIT_TIME))
        
        # 12 hours = 43200 seconds
        PROMOTION_THRESHOLD=43200
        
        echo "Time since last canary update: $((TIME_DIFF / 3600)) hours"
        
        if [ $TIME_DIFF -gt $PROMOTION_THRESHOLD ]; then
          echo "Canary has been running for more than 4 hours. Promoting to stable..."
          
          # Update stable deployment image to canary image
          sed -i "s|image:.*|image: $CANARY_IMAGE|g" base/deployment-stable.yaml
          
          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add base/deployment-stable.yaml
          git commit -m "chore: auto-promote canary to stable (after $((TIME_DIFF / 3600))h) - $CANARY_IMAGE"
          git push
          
          echo "âœ… Promotion completed!"
        else
          echo "Canary has been running for less than 4 hours. Skipping promotion."
        fi
